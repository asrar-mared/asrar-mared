# Ø§Ù„Ù…Ø³Ø§Ø±: .github/workflows/main.yml
# ğŸ›¡ï¸ Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
# Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ù† Ø¬Ø°Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:
# .github/workflows/main.yml

name: ğŸ›¡ï¸ Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ø³ÙŠØ± Ø¹Ù…Ù„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ÙØ­Øµ Ø£Ù…Ù†ÙŠ ÙŠÙˆÙ…ÙŠ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

# Ø£Ø°ÙˆÙ†Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ø£Ù…Ø§Ù†
permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write

jobs:
  # ========================================
  # 1. ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø«ØºØ±Ø§Øª
  # ========================================
  security-scan:
    name: ğŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ù…Ø³Ø±Ø¨Ø©
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          
      - name: ğŸ›¡ï¸ ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© - CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python
          queries: security-and-quality
          
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„Ù„ØªØ­Ù„ÙŠÙ„
        uses: github/codeql-action/autobuild@v3
        
      - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ CodeQL
        uses: github/codeql-action/analyze@v3
        
      - name: ğŸ” ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ø¹ÙŠÙØ©
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=moderate
          fi
          if [ -f requirements.txt ]; then
            pip install safety
            safety check -r requirements.txt
          fi
          
      - name: ğŸš¨ ÙØ­Øµ OWASP Ù„Ù„Ø«ØºØ±Ø§Øª
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

  # ========================================
  # 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
  # ========================================
  code-quality:
    name: âœ¨ ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ¨ ÙØ­Øµ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡
        run: |
          npm run lint || true
          npm run format:check || true
          
      - name: ğŸ“ˆ ØªØ­Ù„ÙŠÙ„ SonarQube
        uses: sonarsource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
        run: npx jscpd . --min-lines 5 --min-tokens 50

  # ========================================
  # 3. Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©
  # ========================================
  test:
    name: ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©
    runs-on: ${{ matrix.os }}
    needs: code-quality
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [16, 18, 20]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: npm ci
        
      - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
        run: npm test -- --coverage --maxWorkers=2
        
      - name: ğŸ“Š Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØºØ·ÙŠØ©
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-${{ matrix.os }}-${{ matrix.node }}

  # ========================================
  # 4. Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù†Ø´Ø±
  # ========================================
  build:
    name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª ÙˆØ¨Ù†Ø§Ø¡
        run: |
          npm ci
          npm run build
          
      - name: ğŸ—œï¸ Ø¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª
        run: tar -czf build.tar.gz dist/
        
      - name: ğŸ“¤ Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø§Ø¡
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: build.tar.gz
          retention-days: 7

  # ========================================
  # 5. ÙØ­Øµ Docker ÙˆØ§Ù„Ø­Ø§ÙˆÙŠØ§Øª
  # ========================================
  docker-security:
    name: ğŸ³ ÙØ­Øµ Ø£Ù…Ø§Ù† Docker
    runs-on: ubuntu-latest
    needs: build
    if: hashFiles('Dockerfile') != ''
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ ØµÙˆØ±Ø© Docker
        run: docker build -t digital-mared:${{ github.sha }} .
        
      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© - Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: digital-mared:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          
      - name: ğŸ“Š Ø±ÙØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: ğŸ” ÙØ­Øµ Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

  # ========================================
  # 6. Ø­Ù…Ø§ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  # ========================================
  advanced-protection:
    name: ğŸ›¡ï¸ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ” ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
        run: |
          echo "ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©..."
          find . -name "*.env*" -o -name "*.key" -o -name "*.pem" -o -name "*credentials*" | while read file; do
            if [ -f "$file" ]; then
              echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ù„Ù Ø­Ø³Ø§Ø³ Ù…ÙˆØ¬ÙˆØ¯: $file"
            fi
          done
          
      - name: ğŸš« Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø®Ø·Ø±Ø©
        run: |
          echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù†Ù…Ø§Ø· Ø®Ø·Ø±Ø©..."
          grep -r "eval(" --include="*.js" --include="*.ts" . && echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… eval() Ø®Ø·Ø±" || true
          grep -r "exec(" --include="*.py" . && echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… exec() Ø®Ø·Ø±" || true
          grep -r "dangerouslySetInnerHTML" --include="*.jsx" --include="*.tsx" . && echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… dangerouslySetInnerHTML" || true
          
      - name: ğŸ“ ÙØ­Øµ Ø§Ù„ØªØ±Ø®ÙŠØµ ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„
        uses: pivotal/LicenseFinder@v7.0.1
        
      - name: ğŸ”” Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'ğŸš¨ ÙØ´Ù„ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ù„Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ========================================
  # 7. Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ©
  # ========================================
  backup:
    name: ğŸ’¾ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        run: |
          tar -czf backup-${{ github.sha }}.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            .
            
      - name: ğŸ” ØªØ´ÙÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        run: |
          openssl enc -aes-256-cbc -salt \
            -in backup-${{ github.sha }}.tar.gz \
            -out backup-${{ github.sha }}.tar.gz.enc \
            -k "${{ secrets.BACKUP_ENCRYPTION_KEY }}"
            
      - name: â˜ï¸ Ø±ÙØ¹ Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        uses: actions/upload-artifact@v4
        with:
          name: encrypted-backup-${{ github.sha }}
          path: backup-${{ github.sha }}.tar.gz.enc
          retention-days: 30

  # ========================================
  # 8. Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
  # ========================================
  final-report:
    name: ğŸ“‹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality, test, docker-security, advanced-protection]
    if: always()
    
    steps:
      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„
        run: |
          echo "# ğŸ›¡ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ" > report.md
          echo "" >> report.md
          echo "## ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date)" >> report.md
          echo "## ğŸ”– Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ github.sha }}" >> report.md
          echo "" >> report.md
          echo "### âœ… Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:" >> report.md
          echo "- ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„" >> report.md
          echo "- ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯" >> report.md
          echo "- Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©" >> report.md
          echo "- ÙØ­Øµ Ø£Ù…Ø§Ù† Docker" >> report.md
          echo "- Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©" >> report.md
          
      - name: ğŸ’¬ Ù†Ø´Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ›¡ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠ - ' + new Date().toISOString().split('T')[0],
              body: report,
              labels: ['security', 'automated']
            });
