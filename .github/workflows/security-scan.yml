# Ø§Ù„Ù…Ø³Ø§Ø±: .github/workflows/security-scan.yml
# ğŸ›¡ï¸ Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
# Ù†Ø¸Ø§Ù… Ø´Ø§Ù…Ù„ Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø«ØºØ±Ø§Øª ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¨Ø§Ù‚ÙŠØ©

name: ğŸ”’ Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„

on:
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ÙƒÙ„ Push Ùˆ Pull Request
  push:
    branches: [ main, develop, staging ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  
  # ÙØ­Øµ Ø£Ù…Ù†ÙŠ ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ
  schedule:
    - cron: '0 2 * * *'  # ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹
    - cron: '0 14 * * *' # ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 2 Ø¸Ù‡Ø±Ø§Ù‹
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  workflow_dispatch:
    inputs:
      scan_level:
        description: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙØ­Øµ'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - standard
          - full
          - deep
      notify_team:
        description: 'Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„ÙØ±ÙŠÙ‚'
        required: false
        type: boolean
        default: true

# Ø£Ø°ÙˆÙ†Ø§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù‚ØµÙˆÙ‰
permissions:
  contents: read
  security-events: write
  pull-requests: write
  issues: write
  actions: read
  checks: write

env:
  SCAN_TIMEOUT: 45
  MAX_CRITICAL_ISSUES: 0
  MAX_HIGH_ISSUES: 5
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18.x'
  GO_VERSION: '1.21'

jobs:
  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªØ­Ù„ÙŠÙ„ Ø£ÙˆÙ„ÙŠ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
  # ========================================
  pre-scan-analysis:
    name: ğŸ“‹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has_dockerfile: ${{ steps.check.outputs.has_dockerfile }}
      has_package_json: ${{ steps.check.outputs.has_package_json }}
      has_requirements: ${{ steps.check.outputs.has_requirements }}
      has_go_mod: ${{ steps.check.outputs.has_go_mod }}
      project_languages: ${{ steps.detect.outputs.languages }}
      
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” ÙØ­Øµ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        id: check
        run: |
          echo "has_dockerfile=$([ -f Dockerfile ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_package_json=$([ -f package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_requirements=$([ -f requirements.txt ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_go_mod=$([ -f go.mod ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
      
      - name: ğŸŒ ÙƒØ´Ù Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
        id: detect
        run: |
          languages=""
          [ -f "*.js" ] || [ -f "*.ts" ] && languages="${languages}javascript,"
          [ -f "*.py" ] && languages="${languages}python,"
          [ -f "*.go" ] && languages="${languages}go,"
          [ -f "*.java" ] && languages="${languages}java,"
          echo "languages=${languages}" >> $GITHUB_OUTPUT
          echo "ğŸ” Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${languages}"

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
  # ========================================
  secrets-detection:
    name: ğŸ” ÙƒØ´Ù Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ù…Ø³Ø±Ø¨Ø©
    runs-on: ubuntu-latest
    needs: pre-scan-analysis
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” TruffleHog - ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø±
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified
      
      - name: ğŸ•µï¸ GitLeaks - ÙØ­Øµ ØªØ³Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      
      - name: ğŸ” ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­
        run: |
          echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø­Ø³Ø§Ø³Ø©..."
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
          find . -type f \( -name "*.env*" -o -name ".env.*" \) ! -name "*.example" | while read file; do
            if [ -f "$file" ]; then
              echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ù„Ù Ø¨ÙŠØ¦Ø© Ù…ÙˆØ¬ÙˆØ¯: $file"
              exit 1
            fi
          done
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙØ§ØªÙŠØ­ SSH
          find . -type f \( -name "*.pem" -o -name "*.key" -o -name "id_rsa*" \) | while read file; do
            if [ -f "$file" ]; then
              echo "ğŸš¨ Ø®Ø·Ø±: Ù…ÙØªØ§Ø­ SSH Ù…ÙˆØ¬ÙˆØ¯: $file"
              exit 1
            fi
          done
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
          find . -type f \( -name "*credentials*" -o -name "*password*" -o -name "*secret*" \) \
            ! -path "*/node_modules/*" ! -path "*/.git/*" | while read file; do
            if [ -f "$file" ]; then
              echo "âš ï¸ Ù…Ù„Ù Ø§Ø¹ØªÙ…Ø§Ø¯ Ù…Ø­ØªÙ…Ù„: $file"
            fi
          done
          
          echo "âœ… ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù…ÙƒØªÙ…Ù„"
      
      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø­Ø³Ø§Ø³Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
        run: |
          echo "ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø·Ø±Ø©..."
          
          # AWS Keys
          if grep -r "AKIA[0-9A-Z]{16}" . --exclude-dir={.git,node_modules}; then
            echo "ğŸš¨ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ AWS!"
            exit 1
          fi
          
          # Google API Keys
          if grep -r "AIza[0-9A-Za-z\\-_]{35}" . --exclude-dir={.git,node_modules}; then
            echo "ğŸš¨ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ Google API!"
            exit 1
          fi
          
          # Generic API Keys
          if grep -ri "api[_-]key.*['\"][0-9a-zA-Z]{32,}['\"]" . --exclude-dir={.git,node_modules}; then
            echo "âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ API Ù…Ø­ØªÙ…Ù„Ø©!"
          fi
          
          # Database URLs with passwords
          if grep -ri "mongodb.*://.*:.*@" . --exclude-dir={.git,node_modules}; then
            echo "ğŸš¨ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ URLs Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ±!"
            exit 1
          fi
          
          echo "âœ… ÙØ­Øµ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…ÙƒØªÙ…Ù„"

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ø¨Øª - CodeQL
  # ========================================
  codeql-analysis:
    name: ğŸ”¬ ØªØ­Ù„ÙŠÙ„ CodeQL Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    runs-on: ubuntu-latest
    needs: [pre-scan-analysis, secrets-detection]
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'python']
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
          config-file: ./.github/codeql/codeql-config.yml
      
      - name: ğŸ—ï¸ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        uses: github/codeql-action/autobuild@v3
      
      - name: ğŸ” ØªØ­Ù„ÙŠÙ„ CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          output: sarif-results
          upload: true

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙˆØ§Ù„Ø«ØºØ±Ø§Øª
  # ========================================
  dependency-scan:
    name: ğŸ“¦ ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
    runs-on: ubuntu-latest
    needs: pre-scan-analysis
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        if: needs.pre-scan-analysis.outputs.has_package_json == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Python
        if: needs.pre-scan-analysis.outputs.has_requirements == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ğŸ“Š NPM Audit - ÙØ­Øµ Ø­Ø²Ù… Node
        if: needs.pre-scan-analysis.outputs.has_package_json == 'true'
        continue-on-error: true
        run: |
          npm ci --prefer-offline
          npm audit --audit-level=moderate --json > npm-audit.json
          
          # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          critical=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical')
          high=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high')
          
          echo "ğŸ” Ø«ØºØ±Ø§Øª Ø­Ø±Ø¬Ø©: $critical"
          echo "âš ï¸ Ø«ØºØ±Ø§Øª Ø¹Ø§Ù„ÙŠØ©: $high"
          
          if [ "$critical" -gt "$MAX_CRITICAL_ISSUES" ]; then
            echo "ğŸš¨ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©!"
            exit 1
          fi
      
      - name: ğŸ Safety Check - ÙØ­Øµ Ø­Ø²Ù… Python
        if: needs.pre-scan-analysis.outputs.has_requirements == 'true'
        run: |
          pip install safety
          safety check -r requirements.txt --json > safety-report.json || true
          
          # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          echo "ğŸ“Š ØªÙ‚Ø±ÙŠØ± Safety:"
          cat safety-report.json | jq '.'
      
      - name: ğŸ” Snyk - ÙØ­Øµ Ø´Ø§Ù…Ù„ Ù„Ù„Ø«ØºØ±Ø§Øª
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json
      
      - name: ğŸ“Š OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Digital-warrior-secrets'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
      
      - name: ğŸ“¤ Ø±ÙØ¹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø«ØºØ±Ø§Øª
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-reports
          path: |
            npm-audit.json
            safety-report.json
            snyk-report.json
            dependency-check-report.html
          retention-days: 30

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: ÙØ­Øµ Ø£Ù…Ø§Ù† Docker
  # ========================================
  docker-security-scan:
    name: ğŸ³ ÙØ­Øµ Ø£Ù…Ø§Ù† Docker
    runs-on: ubuntu-latest
    needs: pre-scan-analysis
    if: needs.pre-scan-analysis.outputs.has_dockerfile == 'true'
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ ØµÙˆØ±Ø© Docker
        run: |
          docker build -t digital-warrior:${{ github.sha }} .
          docker tag digital-warrior:${{ github.sha }} digital-warrior:latest
      
      - name: ğŸ” Trivy - ÙØ­Øµ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø§Ù…Ù„
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: digital-warrior:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          exit-code: '1'
      
      - name: ğŸ”’ Hadolint - ÙØ­Øµ Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
      
      - name: ğŸ” Dockle - ÙØ­Øµ Ø£Ù…Ø§Ù† Ø§Ù„ØµÙˆØ±Ø©
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -L -o dockle.tar.gz https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.tar.gz
          tar zxvf dockle.tar.gz
          sudo mv dockle /usr/local/bin
          
          dockle --exit-code 1 --exit-level warn digital-warrior:${{ github.sha }}
      
      - name: ğŸ” Grype - ÙØ­Øµ Ø«ØºØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠ
        uses: anchore/scan-action@v3
        with:
          image: digital-warrior:${{ github.sha }}
          fail-build: true
          severity-cutoff: high
      
      - name: ğŸ“Š Ø±ÙØ¹ Ù†ØªØ§Ø¦Ø¬ Trivy
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: ÙØ­Øµ OWASP Ù„Ù„Ø«ØºØ±Ø§Øª
  # ========================================
  owasp-zap-scan:
    name: ğŸ•·ï¸ ÙØ­Øµ OWASP ZAP
    runs-on: ubuntu-latest
    needs: [secrets-detection, codeql-analysis]
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build || true
            npm start &
            sleep 10
          fi
      
      - name: ğŸ•·ï¸ ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
      
      - name: ğŸ•¸ï¸ ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        if: github.ref == 'refs/heads/main'
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
      
      - name: ğŸ“Š Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± ZAP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-report
          path: |
            zap-report.html
            zap-report.json
          retention-days: 30

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: ÙØ­Øµ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø± ÙˆØ§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø³ÙŠØ¦Ø©
  # ========================================
  code-security-patterns:
    name: ğŸš¨ ÙØ­Øµ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø·Ø±Ø©
    runs-on: ubuntu-latest
    needs: pre-scan-analysis
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ” ÙØ­Øµ JavaScript/TypeScript Ø§Ù„Ø®Ø·Ø±
        run: |
          echo "ğŸ” ÙØ­Øµ Ø£Ù†Ù…Ø§Ø· JavaScript Ø§Ù„Ø®Ø·Ø±Ø©..."
          
          # eval() usage
          if grep -rn "eval(" --include="*.js" --include="*.ts" --exclude-dir=node_modules .; then
            echo "ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… eval() Ø®Ø·Ø± Ø¬Ø¯Ø§Ù‹!"
            echo "eval_found=true" >> $GITHUB_ENV
          fi
          
          # Function constructor
          if grep -rn "new Function(" --include="*.js" --include="*.ts" --exclude-dir=node_modules .; then
            echo "ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Function constructor Ø®Ø·Ø±!"
          fi
          
          # innerHTML without sanitization
          if grep -rn "innerHTML.*=" --include="*.js" --include="*.jsx" --exclude-dir=node_modules . | grep -v "sanitize"; then
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… innerHTML Ø¨Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠÙ…!"
          fi
          
          # dangerouslySetInnerHTML
          if grep -rn "dangerouslySetInnerHTML" --include="*.jsx" --include="*.tsx" --exclude-dir=node_modules .; then
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… dangerouslySetInnerHTML!"
          fi
          
          # document.write
          if grep -rn "document.write" --include="*.js" --include="*.ts" --exclude-dir=node_modules .; then
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… document.write Ø®Ø·Ø±!"
          fi
      
      - name: ğŸ ÙØ­Øµ Python Ø§Ù„Ø®Ø·Ø±
        run: |
          echo "ğŸ” ÙØ­Øµ Ø£Ù†Ù…Ø§Ø· Python Ø§Ù„Ø®Ø·Ø±Ø©..."
          
          # exec() usage
          if grep -rn "exec(" --include="*.py" --exclude-dir=venv .; then
            echo "ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… exec() Ø®Ø·Ø±!"
          fi
          
          # eval() usage
          if grep -rn "eval(" --include="*.py" --exclude-dir=venv .; then
            echo "ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… eval() Ø®Ø·Ø±!"
          fi
          
          # pickle without validation
          if grep -rn "pickle.loads" --include="*.py" --exclude-dir=venv .; then
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… pickle.loads Ø¨Ø¯ÙˆÙ† ØªØ­Ù‚Ù‚!"
          fi
          
          # SQL injection patterns
          if grep -rn "execute.*%.*%" --include="*.py" --exclude-dir=venv .; then
            echo "ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ø­ØªÙ…Ø§Ù„ SQL injection!"
          fi
      
      - name: ğŸ”’ ÙØ­Øµ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ù…Ø§Ù†
        run: |
          echo "ğŸ” ÙØ­Øµ Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø¹Ø§Ù…Ø©..."
          
          # Hardcoded IPs
          if grep -rn "[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}" . \
            --include="*.js" --include="*.py" --exclude-dir={node_modules,venv} | grep -v "127.0.0.1\|0.0.0.0\|localhost"; then
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¹Ù†Ø§ÙˆÙŠÙ† IP Ù…ÙƒØªÙˆØ¨Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!"
          fi
          
          # TODO/FIXME security comments
          if grep -rni "TODO.*security\|FIXME.*security\|XXX.*security" . \
            --exclude-dir={node_modules,venv,.git}; then
            echo "âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø£Ù…Ù†ÙŠØ© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©"
          fi
      
      - name: âŒ ÙØ´Ù„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£Ù†Ù…Ø§Ø· Ø®Ø·Ø±Ø©
        if: env.eval_found == 'true'
        run: |
          echo "ğŸš¨ ÙØ´Ù„ Ø§Ù„ÙØ­Øµ: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ù†Ù…Ø§Ø· Ø®Ø·Ø±Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!"
          exit 1

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8: ÙØ­Øµ Ø§Ù„ØªØ±Ø®ÙŠØµ ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„
  # ========================================
  license-compliance:
    name: ğŸ“œ ÙØ­Øµ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ
    runs-on: ubuntu-latest
    needs: pre-scan-analysis
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª license-checker
        run: npm install -g license-checker
      
      - name: ğŸ” ÙØ­Øµ ØªØ±Ø§Ø®ÙŠØµ NPM
        if: needs.pre-scan-analysis.outputs.has_package_json == 'true'
        run: |
          npm ci
          license-checker --json --out licenses-npm.json
          
          # ÙØ­Øµ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
          license-checker --onlyAllow "MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;0BSD" || echo "âš ï¸ ØªØ­Ø°ÙŠØ±: ØªØ±Ø§Ø®ÙŠØµ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©"
      
      - name: ğŸ“œ ÙØ­Øµ Ù…Ù„Ù LICENSE
        run: |
          if [ ! -f LICENSE ]; then
            echo "âš ï¸ ØªØ­Ø°ÙŠØ±: Ù…Ù„Ù LICENSE ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi
          echo "âœ… Ù…Ù„Ù LICENSE Ù…ÙˆØ¬ÙˆØ¯"
      
      - name: ğŸ“¤ Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: licenses-npm.json
          retention-days: 30

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 9: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  # ========================================
  penetration-testing:
    name: ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 40
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        run: |
          docker-compose up -d || echo "No docker-compose file"
          sleep 15
      
      - name: ğŸ¯ Nuclei - ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª
        uses: projectdiscovery/nuclei-action@main
        with:
          target: http://localhost:3000
          templates: cves,vulnerabilities,exposures
      
      - name: ğŸ” Nikto - ÙØ­Øµ Ø§Ù„ÙˆÙŠØ¨
        run: |
          docker run --network host frapsoft/nikto -h http://localhost:3000 -output nikto-report.html || true
      
      - name: ğŸ“Š Ø±ÙØ¹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: penetration-test-reports
          path: |
            nuclei-report.json
            nikto-report.html
          retention-days: 30

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 10: Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  # ========================================
  security-report:
    name: ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    runs-on: ubuntu-latest
    needs: [
      secrets-detection,
      codeql-analysis,
      dependency-scan,
      docker-security-scan,
      owasp-zap-scan,
      code-security-patterns,
      license-compliance
    ]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        uses: actions/download-artifact@v4
        with:
          path: security-reports
      
      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„
        run: |
          cat << EOF > security-summary.md
          # ğŸ›¡ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ
          
          ## ğŸ“… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ­Øµ
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date '+%Y-%m-%d %H:%M:%S')
          - **Ø§Ù„ÙØ±Ø¹**: ${{ github.ref_name }}
          - **Ø§Ù„Ø¥ØµØ¯Ø§Ø±**: ${{ github.sha }}
          - **Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…**: ${{ github.actor }}
          
          ## ğŸ¯ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ
          
          ### âœ… Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:
          - ğŸ” ÙƒØ´Ù Ø§Ù„Ø£Ø³Ø±Ø§Ø± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
          - ğŸ”¬ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø«Ø§Ø¨Øª (CodeQL)
          - ğŸ“¦ ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙˆØ§Ù„Ø«ØºØ±Ø§Øª
          - ğŸ³ ÙØ­Øµ Ø£Ù…Ø§Ù† Docker
          - ğŸ•·ï¸ ÙØ­Øµ OWASP ZAP
          - ğŸš¨ ÙØ­Øµ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø·Ø±Ø©
          - ğŸ“œ ÙØ­Øµ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ
          
          ### ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:
          - **Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©**: 0 âœ…
          - **Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù„ÙŠØ©**: ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
          - **Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª**: ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
          
          ### ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·:
          - [Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„Ø©](security-reports/)
          
          ---
          
          ğŸ§â€â™‚ï¸ **Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ ÙŠØ­Ù…ÙŠÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹!** ğŸ›¡ï¸
          EOF
          
          cat security-summary.md
      
      - name: ğŸ’¬ Ù†Ø´Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ€ Issue
        uses: actions/github-script@v7
        if: github.event_name == 'schedule' || github.event.inputs.notify_team == 'true'
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-summary.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ›¡ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['security', 'automated-report', 'high-priority']
            });
      
      - name: ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-summary.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
      
      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        uses: actions/upload-artifact@v4
        with:
          name: final-security-report
          path: |
            security-summary.md
            security-reports/
          retention-
