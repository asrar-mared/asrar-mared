# .github/workflows/security-scan.yml
# ğŸ” Security Scanning - Ø£Ø³Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ

name: ğŸ” Security Scanning & Vulnerability Assessment

on:
  push:
    branches: 
      - main
      - develop
      - "security/**"
    paths:
      - "**/*.js"
      - "**/*.ts"
      - "**/*.py"
      - "**/*.go"
      - "**/*.java"
      - "package*.json"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/security-scan.yml"
  pull_request:
    branches: 
      - main
      - develop
    types: [opened, synchronize, reopened]
  schedule:
    # ÙØ­Øµ ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - deep

# Ù…Ù†Ø¹ ØªØ´ØºÙŠÙ„ Ù…ØªØ²Ø§Ù…Ù†
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: false  # Ù„Ø§ Ù†Ù„ØºÙŠ ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ø§Ù†

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write
  issues: write

env:
  SCAN_SEVERITY: "CRITICAL,HIGH,MEDIUM"
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20.x"
  GO_VERSION: "1.21"

jobs:
  # ===================================
  # Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹
  # ===================================
  quick-security-check:
    name: âš¡ Quick Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Scan for Secrets (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --fail

      - name: ğŸ” Detect Hardcoded Secrets (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: ğŸ“‹ Check for Sensitive Files
        run: |
          echo "ğŸ” Checking for sensitive files..."
          SENSITIVE_FILES=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "*.jks"
            "*.keystore"
            "*.env"
            "*.env.*"
            "*id_rsa*"
            "*id_ed25519*"
            "*.gpg"
            "*.asc"
            "credentials.json"
            "secrets.json"
          )
          
          FOUND=0
          for pattern in "${SENSITIVE_FILES[@]}"; do
            if find . -name "$pattern" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
              echo "âš ï¸ Found potentially sensitive files matching: $pattern"
              find . -name "$pattern" -not -path "*/node_modules/*" -not -path "*/.git/*"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "âŒ Sensitive files detected!"
            exit 1
          else
            echo "âœ… No sensitive files found"
          fi

  # ===================================
  # ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙˆØ§Ù„Ø«ØºØ±Ø§Øª
  # ===================================
  dependency-scanning:
    name: ğŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    needs: quick-security-check
    timeout-minutes: 20
    
    strategy:
      matrix:
        scanner: [npm-audit, snyk, trivy]
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ===== NPM Audit =====
      - name: ğŸŸ¢ Setup Node.js
        if: matrix.scanner == 'npm-audit'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ” NPM Audit
        if: matrix.scanner == 'npm-audit'
        run: |
          if [ -f "package.json" ]; then
            echo "ğŸ” Running npm audit..."
            npm audit --audit-level=moderate --json > npm-audit.json || true
            
            # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            if [ -f "npm-audit.json" ]; then
              cat npm-audit.json | jq '.vulnerabilities' || cat npm-audit.json
              
              # ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
              CRITICAL=$(cat npm-audit.json | jq '.metadata.vulnerabilities.critical // 0')
              HIGH=$(cat npm-audit.json | jq '.metadata.vulnerabilities.high // 0')
              
              echo "ğŸ”´ Critical: $CRITICAL"
              echo "ğŸŸ  High: $HIGH"
              
              if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
                echo "âŒ Critical or High vulnerabilities found!"
                exit 1
              fi
            fi
          else
            echo "âš ï¸ No package.json found"
          fi

      # ===== Snyk =====
      - name: ğŸ›¡ï¸ Snyk Security Scan
        if: matrix.scanner == 'snyk'
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-report.json

      - name: ğŸ“¤ Upload Snyk Report
        if: matrix.scanner == 'snyk' && always()
        uses: actions/upload-artifact@v4
        with:
          name: snyk-security-report
          path: snyk-report.json
          retention-days: 30

      # ===== Trivy =====
      - name: ğŸ³ Trivy Vulnerability Scanner
        if: matrix.scanner == 'trivy'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: ğŸ“¤ Upload Trivy SARIF
        if: matrix.scanner == 'trivy' && always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-filesystem'

  # ===================================
  # ÙØ­Øµ Python (Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯)
  # ===================================
  python-security:
    name: ğŸ Python Security Scan
    runs-on: ubuntu-latest
    needs: quick-security-check
    timeout-minutes: 15
    if: hashFiles('requirements.txt', 'setup.py', 'Pipfile') != ''
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit pip-audit

      - name: ğŸ” Safety Check (Known Vulnerabilities)
        run: |
          if [ -f "requirements.txt" ]; then
            echo "ğŸ” Running Safety check..."
            safety check --file requirements.txt --json > safety-report.json || true
            cat safety-report.json
          fi

      - name: ğŸ”’ Bandit (Security Issues in Code)
        run: |
          if find . -name "*.py" -not -path "*/venv/*" | grep -q .; then
            echo "ğŸ” Running Bandit..."
            bandit -r . -f json -o bandit-report.json || true
            cat bandit-report.json
          fi

      - name: ğŸ›¡ï¸ pip-audit
        run: |
          if [ -f "requirements.txt" ]; then
            echo "ğŸ” Running pip-audit..."
            pip-audit -r requirements.txt --format json > pip-audit.json || true
            cat pip-audit.json
          fi

      - name: ğŸ“¤ Upload Python Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: python-security-reports
          path: |
            safety-report.json
            bandit-report.json
            pip-audit.json
          retention-days: 30

  # ===================================
  # ÙØ­Øµ Docker (Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯)
  # ===================================
  docker-security:
    name: ğŸ³ Docker Security Scan
    runs-on: ubuntu-latest
    needs: quick-security-check
    timeout-minutes: 15
    if: hashFiles('Dockerfile', 'docker-compose.yml') != ''
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Trivy Docker Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-docker.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ” Hadolint Dockerfile Linting
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint.sarif
          no-fail: true

      - name: ğŸ“¤ Upload Docker Security Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: |
            trivy-docker.sarif
            hadolint.sarif
          category: 'docker-security'

  # ===================================
  # OWASP Dependency Check
  # ===================================
  owasp-dependency-check:
    name: ğŸ›¡ï¸ OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: quick-security-check
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'asrar-mared'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
            --suppression suppression.xml

      - name: ğŸ“¤ Upload OWASP Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports/
          retention-days: 30

  # ===================================
  # SAST (Static Application Security Testing)
  # ===================================
  sast-analysis:
    name: ğŸ”¬ SAST Analysis
    runs-on: ubuntu-latest
    needs: dependency-scanning
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/cwe-top-25
            p/ci
          generateSarif: true

      - name: ğŸ“¤ Upload Semgrep SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: 'semgrep'

  # ===================================
  # Container Image Scanning
  # ===================================
  container-scan:
    name: ğŸ“¦ Container Image Security
    runs-on: ubuntu-latest
    needs: docker-security
    if: hashFiles('Dockerfile') != ''
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          docker build -t asrar-mared:test .

      - name: ğŸ” Grype Vulnerability Scan
        uses: anchore/scan-action@v3
        with:
          image: "asrar-mared:test"
          severity-cutoff: medium
          fail-build: true
          output-format: sarif

      - name: ğŸ“¤ Upload Grype Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: 'grype-container'

  # ===================================
  # License Compliance Check
  # ===================================
  license-check:
    name: ğŸ“œ License Compliance
    runs-on: ubuntu-latest
    needs: quick-security-check
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check Licenses
        uses: licensebat/licensebat-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ===================================
  # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„
  # ===================================
  security-report:
    name: ğŸ“Š Security Report Summary
    runs-on: ubuntu-latest
    needs: 
      - dependency-scanning
      - python-security
      - docker-security
      - owasp-dependency-check
      - sast-analysis
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: security-reports/

      - name: ğŸ“Š Generate Summary
        run: |
          echo "# ğŸ” ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„" > security-summary.md
          echo "" >> security-summary.md
          echo "**Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date '+%Y-%m-%d %H:%M:%S')" >> security-summary.md
          echo "**Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹**: ${{ github.repository }}" >> security-summary.md
          echo "**Ø§Ù„ÙØ±Ø¹**: ${{ github.ref_name }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## ğŸ“‹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª" >> security-summary.md
          echo "" >> security-summary.md
          
          # Ø¥Ø¶Ø§ÙØ© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª
          if [ -d "security-reports" ]; then
            find security-reports -name "*.json" -o -name "*.sarif" | while read file; do
              echo "- ğŸ“„ $(basename $file)" >> security-summary.md
            done
          fi
          
          echo "" >> security-summary.md
          echo "## âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©" >> security-summary.md
          echo "Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ù‚Ø¯ Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!" >> security-summary.md
          
          cat security-summary.md

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: ğŸ“¤ Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

  # ===================================
  # Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
  # ===================================
  notify-security-failure:
    name: ğŸš¨ Security Alert
    runs-on: ubuntu-latest
    needs: 
      - dependency-scanning
      - python-security
      - docker-security
      - owasp-dependency-check
      - sast-analysis
    if: failure()
    
    steps:
      - name: ğŸš¨ Create Security Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ: ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ',
              body: `## ğŸš¨ ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ
              
              ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£Ù…Ù†ÙŠ ÙÙŠ:
              - **Ø§Ù„ÙØ±Ø¹**: ${context.ref}
              - **Commit**: ${context.sha}
              - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: ${new Date().toISOString()}
              
              ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙˆØ±Ø§Ù‹!
              
              ### ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
              - [Ø³Ø¬Ù„Ø§Øª Workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})
              - [Commit](${context.payload.repository.html_url}/commit/${context.sha})
              
              @asrar-mared ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡Ø°Ø§ ÙÙˆØ±Ø§Ù‹!`,
              labels: ['security', 'critical', 'automated']
            });

      - name: ğŸ“§ Send Email Alert
        if: secrets.EMAIL_PASSWORD != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.proton.me
          server_port: 587
          username: nike49424@proton.me
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ Ø¹Ø§Ø¬Ù„ - asrar-mared'
          body: |
            ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ: ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ asrar-mared
            
            ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† GitHub Actions ÙÙˆØ±Ø§Ù‹!
          to: nike49424@proton.me
          from: Security Bot <nike49424@proton.me>
